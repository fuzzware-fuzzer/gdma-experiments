#!/bin/bash
DIR="$(dirname "$(readlink -f "$0")")"

# This script is to be run within the contiki docker container

CVENUM=2023-48229
SAMPLE_DIR=/workdir/contiki-ng/examples/hello-world

cd /workdir/contiki-ng
# Restore git state
git reset --hard
git clean -df
git checkout release/v4.9
git submodule update --init arch/cpu/nrf/lib/nrfx
git submodule update --init arch/cpu/nrf/lib/tinyusb
git submodule update --init arch/cpu/arm/CMSIS

# disable soft float for fuzzware
git apply $DIR/patches/soft_float.patch

# radio -> 6LoWPAN
git apply $DIR/patches/6lowpan_sample.patch

rm -rf $SAMPLE_DIR/build
make -j -C $SAMPLE_DIR TARGET=nrf BOARD=nrf52840/dongle clean all

# Copy sample to outside-visible directory
OUT_DIR=/workdir/rebuilt/CVE-$CVENUM
rm -rf $OUT_DIR
mkdir -p $OUT_DIR
cp $SAMPLE_DIR/build/nrf/nrf52840/dongle/hello-world.elf $OUT_DIR
